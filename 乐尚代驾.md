

# 项目笔记-乐尚代驾

## 2025-1-26

### 1.rabbitmq+delayed_message_exchange

```
docker pull rabbitmq:3-management

docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 -v C:/Data/RabbitMQ/plugins:/opt/rabbitmq/plugins rabbitmq:3-management

docker exec rabbitmq rabbitmq-plugins enable rabbitmq_delayed_message_exchange
```

### 2.SQL

![image-20250123203232466](https://s2.loli.net/2025/01/23/8lFh6PoRuSx41vK.png)

### 3.Nacos导入压缩包配置文件
![image-20250123203145456](https://s2.loli.net/2025/01/23/4fRj2bvPz7GYes3.png)

### 4.改Nacos配置中心文件 （多个）

![image-20250123204706970](https://s2.loli.net/2025/01/23/FMf9dKCt3cHNpVE.png)

### 5.微信小程序登录流程

![image-20250124094316978](https://s2.loli.net/2025/01/24/ayNhILumTloCxe4.png)

![image-20250126205546543](https://s2.loli.net/2025/01/26/LXKWSglTGFkIn6c.png)

### 6.微信工具包

####  Maven 引用方式

```
<dependency>
  <groupId>com.github.binarywang</groupId>
  <artifactId>（不同模块参考下文）</artifactId>
  <version>4.7.0</version>
</dependency>
<dependency>
  <groupId>com.github.binarywang</groupId>
  <artifactId>weixin-java-miniapp</artifactId>
  <version>4.7.0</version>
</dependency>
```

- 微信小程序：`weixin-java-miniapp`
- 微信支付：`weixin-java-pay`
- 微信开放平台：`weixin-java-open`
- 微信公众号：`weixin-java-mp`
- 企业微信：`weixin-java-cp`
- 微信视频号/微信小店：`weixin-java-channel`

### 7.微信相关配置类 -》业务类

```java
@Component
public class WxConfigOperator {
    @Resource
    private WxConfigProperties wxConfigProperties;
    @Bean
    public WxMaService wxMaService() {
        WxMaService service = new WxMaServiceImpl();
        WxMaDefaultConfigImpl config =new WxMaDefaultConfigImpl();
        config.setAppid(wxConfigProperties.getAppId());
        config.setAesKey(wxConfigProperties.getSecret());
        service.setWxMaConfig(config);
        return service;
    }
}

@Component
@Data
@ConfigurationProperties(prefix = "wx.minapp")
public class WxConfigProperties {
    private String appId;
    private String secret;
}
```

### 乱总结

#### **尚硅谷提供的相关甜点：**

common包:

​	1.ThreadLocal 叫AuthContextHolder `src/main/java/com/atguigu/daijia/common/util/AuthContextHolder.java`

​	2.Result类 `src/main/java/com/atguigu/daijia/common/result/Result.java`

​	3.全局定义的异常GuiguException `src/main/java/com/atguigu/daijia/common/execption/GuiguException.java`

​	4.Enum的code错误信息类 `src/main/java/com/atguigu/daijia/common/result/ResultCodeEnum.java`

model包:

​	1.entity类

​	2.VO类 这次用的全是VO 没有DTO

#### **自己做的甜点：**

common包：

​	1.login的AOP以及自定义注解 : 通过自定义注解作为AOP的切点 `src/main/java/com/atguigu/daijia/common/login`

#### **主要更改的包:**

##### service包: service-customer 

​	**1.Wx小程序的配置类 WxMaService WxConfigProperties(appId,secret)**

​	**2.controller 调用service层 提取到Feign**  **@RequestMapping("/customer/info")**

授权登录: 输入/customer/info/login/{code}中的code 返回一个Result<Long>（用户id）

```java
@Operation(summary = "授权登录")
@GetMapping("/login/{code}")
public Result<Long> login(@PathVariable("code") String code)
```

获取基本信息：输入/customer/getCustomerLoginInfo/{customerId}中的customerId返回一个Result<CustomerLoginVo>（id对应的VO信息）

```java
//用VO封装
@Operation(summary = "获取客户基本信息")
@GetMapping("/getCustomerLoginInfo/{customerId}")
public Result<CustomerLoginVo> getCustomerInfo(@PathVariable Long customerId)
```

​	**3.service 调用mapper层**

授权登录：public Long login(String code) 

​	获取code值 使用微信工具包对象(WxMaService) 获取微信唯一标识 openid

​	根据openid判断是否第一次登录 返回用户id值 最后用 CustomerLoginLog 登录日志(链接数据库的log表)

获取基本信息：public CustomerLoginVo getCustomerInfo(Long customerId)

​	根据id查询客户信息 封装到VO VO里特有的一个值 是否绑定手机号 返回封装的VO对象

##### web包: web-customer

​	**1.controller 调用service层  @RequestMapping("/customer")**

授权登录: 输入/customer/login/{code}的code，返回一个Result<String>（token）

```java
@Operation(summary = "授权登录")
@GetMapping("/login/{code}")
public Result<String> login(@PathVariable("code") String code)
```

获取基本信息：输入/customer/getCustomerLoginInfo 返回Result<CustomerLoginVo>  （id对应的VO信息）

```java
@GuiguLogin
@Operation(summary = "获取客户登录信息")
@GetMapping("/getCustomerLoginInfo")
public Result<CustomerLoginVo> getCustomerLoginInfo(@RequestHeader("token") String token) 
```

​	**2.service 调用Feign**

授权登录：public String login(String code) 

​	拿着code进行**远程调用** 返回用户id** 生成token放入redis 设置时限 返回token

获取基本信息：public CustomerLoginVo getCustomerLoginInfo(String token)

​	请求头获取字符串token 查redis里的token **远程根据id调用**service-customer 返回个包含VO的Result类型

##### cline包 service-cline

主要是service包提供的，供web层调用的标准接口

```java
//Feign接口
@FeignClient(value = "service-customer")
public interface CustomerInfoFeignClient {

    @GetMapping("/customer/info/login/{code}")
     Result<Long> login(@PathVariable("code") String code);

    @GetMapping("/customer/info/getCustomerLoginInfo/{customerId}")
    Result<CustomerLoginVo> getCustomerLoginInfo(@PathVariable("customerId") Long customerId);
}
```

**主要完成了customer 用户的登录以及验证，外加甜点知识AOP自定义注解类**

前端 -》web层controller对应的地址 -》web层处理 -》调用Feign接口 -》将方法转换为HTTP请求即所被提取的方法的请求地址 -》service层controller对应的地址

#### 坑

docker容器访问宿主MySQL需要更改root权限 ：让让root可以从任何地址访问

```sql
UPDATE mysql.user SET Host='%' WHERE User='root';
FLUSH PRIVILEGES;
```

SQL数据库报错：如果显示`Public Key Retrieval is not allowed`

```
spring.datasource.url=jdbc:mysql://localhost:3306/your_database?allowPublicKeyRetrieval=true
```

在database名称?xxx&xxx&加上allowPublicKeyRetrieval=true

Feign与HTPP

前端发HTTP请求，匹配URL路径

服务间通过Feign调用，本质是接口方法调用，但Feign会把方法调用转换成HTTP请求

当请求到达时,系统会:

-  匹配请求URL路径
-  找到对应的 @GetMapping 注解
-  执行该注解所在的方法

## 2025-1-27

### 乱总结

照猫画虎解决司机登录问题，进入腾讯云阶段

解决图片/文件上传 看官方SDK

解决ocr识别 看官方SDK

用Swagger测试通过 正确识别身份证和驾驶证信息

### 坑

没啥坑吧 除了登录，业务逻辑都很通顺

有一个图片/文件上传时候，粗心忘了Feign接口要和web的Controller一样的配置 url传不过去

错误的原因是参数名不匹配，我们需要确保 Feign 客户端和服务端的参数名完全一致

签名要GET方法 方法总是看错 上传文件要POST

## 2025-1-28

### 乱总结

完成了剩余接口的上传 主要是登录认证界面的表单：

①将上传身份证照片后识别，将驾驶证照片上传后识别，添加额外的联系人及手机号，将识别出来的各种信息POST到updateDriverAuthInfo 用的是后端的Form对象

②上传信息表单后，传自己图片，头像认证表单POST到updateDriverFaceModel 用的也是后端的表单对象

### 坑

- AOP加注解实现拦截器，只需在web层的controller应用注解 

- TheardLocal不能实现服务间的调用，在本案例的TheardLocal在web层，在后面两个表单上传时，在web层将id取出放入表单达到传递id效果
- web层的controller Feign接口的方法 service层的controller都要一致！！！！！！！一定要一致！！！！！！

